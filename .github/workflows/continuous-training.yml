name: Continuous-Training
on: workflow_dispatch

env:
  RESOURCE_GROUP: mlops-rg
  WORKSPACE: azure-ml-toyota-demo
  TRAIN_PIPELINE_NAME: train-pipeline
  PIPELINE_ENDPOINT_NAME: train-pipeline-endpoint
  EXPERIMENT_NAME: CT-Workflow-Experiment

jobs:
  run_train_endpoint:
    name: run_train_endpoint
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/lukas-lundmark/mlops-ci-image:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: AML Login
        uses: ./.github/actions/aml_login
        with:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          WORKSPACE: ${{ env.WORKSPACE }}

      - name: Start Pipeline
        id: start-pipeline
        run: |
          OUTPUTFILE=status-output.txt
          python -m ml_pipelines.complex_pipeline.run_pipeline  \
              --status-output $OUTPUTFILE
          echo ::set-output name=status::$(cat $OUTPUTFILE)

      - name: Check status of Pipeline Run
        id: check-pipeline
        run: |
          status=${{ steps.start-pipeline.outputs.status }}
          if [ "$status" = "Canceled" ]; then
              echo "Pipeline was canceled"
          elif [ "$status" = "Failed" ]; then
              echo "Pipeline failed"
          else
              echo "Pipeline succeeded"
          fi
